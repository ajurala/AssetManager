function transformURIRequest(a){str=[];for(p in a){str.push(encodeURIComponent(p)+"="+encodeURIComponent(a[p]))}result=str.join("&");console.log(result);return result}function checkStatus(a,e,c,b){return b.defferred.promise.then(function(f){return b.assetsotherinfodefferred.promise}).then(function(f){return b.assetsinfodefferred.promise}).then(function(f){return check_login(a,e,c,b)})}function check_login(b,g,f,e){var a=b.defer();data=e.data;if(!data.configured){if(g.path()==="/user/firstrun"){c(a)}else{a.reject();g.path("/user/firstrun")}}else{if(g.path()==="/user/firstrun"){a.reject();g.path("/")}else{if(g.path()==="/login"){if(data.loggedin){a.reject();g.path("/")}else{c(a)}}else{if(data.loggedin){c(a)}else{a.reject();g.path("/login")}}}}function c(h){if(g.path()!=="/user/update"&&e.data.userinfo["username"]!=e.currentuser.username){e.currentuser.username=e.data.userinfo["username"];e.currentuser.displayname=e.data.userinfo["displayname"]}h.resolve()}return a.promise}function navbarController(b,g,f,e,a,c){b.isCollapsed=true;b.$watch(function(){return c.data},function(h){a.loggedin=h.loggedin;a.username=h.userinfo["username"];a.displayname=h.userinfo["displayname"];a.admin=h.userinfo["admin"]});b.logout=function(){g({method:"POST",url:"login/logoutUser"}).success(function(){c.updateSession();e.location.href=""})}}function userprofileController(a,b){a.editUserProfile=function(){b.path("/user/update")}}function usersController(a,e,c,b){a.getUsersInfo=function(){e({method:"POST",url:"user/users/all"}).success(function(f){if(f){a.users=f}})};a.editUserProfile=function(h,g,f){b.currentuser.username=h;b.currentuser.displayname=g;b.currentuser.admin=f;c.path("/user/update")};a.getUsersInfo()}function categoryModelController(b,a,e,g,f,c){b.categorydetails=f;b.assetsOtherInfo=f.assetsOtherInfo;b.ok=function(){b.riskError="";b.knownCombinationError="";foundcombination=false;subcategories=b.assetsOtherInfo.subcategories;for(i=0;i<subcategories.length;++i){if(b.categorydetails.entereddetails.subcategoryname==subcategories[i].subcategoryname){subcategoryid=subcategories[i].subcategoryid;categoryid=subcategories[i].categoryid;categories=b.assetsOtherInfo.categories;for(i=0;i<categories.length;++i){if(categories[i].categoryid==categoryid&&b.categorydetails.entereddetails.categoryname==categories[i].categoryname){foundcombination=true;break}}}if(foundcombination){break}}riskname=b.categorydetails.entereddetails.riskname;if(foundcombination||riskname==null){if(foundcombination){b.knownCombinationError="Asset type and Sub-Asset type combination already exists. Provide different combination"}if(riskname==null){b.riskError="No such risk category. Choose on in the list"}}else{categoryid="0";categories=b.assetsOtherInfo.categories;for(i=0;i<categories.length;++i){if(b.categorydetails.entereddetails.categoryname==categories[i].categoryname){categoryid=categories[i].categoryid;break}}subcategoryid="0";riskid="0";riskcategories=b.assetsOtherInfo.riskcategories;for(i=0;i<riskcategories.length;++i){if(riskcategories[i].riskname==riskname){riskid=riskcategories[i].riskid;break}}d={};if(categoryid=="0"){category={categoryname:b.categorydetails.entereddetails.categoryname,color:b.categorydetails.entereddetails.categorycolor};d.category=angular.toJson(category)}subcategory={categoryid:categoryid,riskid:riskid,subcategoryname:b.categorydetails.entereddetails.subcategoryname,currentpriceperunit:b.categorydetails.entereddetails.currentpriceperunit,unitform:b.categorydetails.entereddetails.unitform,color:b.categorydetails.entereddetails.subcategorycolor};d.subcategory=angular.toJson(subcategory);g({method:"POST",url:"home/addcategorysubcategory",data:d,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(h){console.log("successfully sent data to server for category");if(h){entereddetails={categoryname:b.categorydetails.entereddetails.categoryname,subcategoryname:b.categorydetails.entereddetails.subcategoryname,subcategoryid:h.subcategorydetails.subcategoryid};f=h.categorydetails;subcategorydetails=h.subcategorydetails;if(f!=null){c.assetsotherinfo.categories.push(f)}c.assetsotherinfo.subcategories.push(subcategorydetails);e.close(entereddetails)}})}};b.cancel=function(){e.dismiss("cancel")}}app.controller("assetsController",function(b,a,g,f,c,e){e.assetsotherinfodefferred.promise.then(function(h){return e.assetsinfodefferred.promise}).then(function(h){b.updateAssetsData()});b.$on("assetsupdated",function(h,j){if(j!="assetsController"){b.updateAssetsData()}});b.updateAssetsData=function(){b.assetsInfo=e.assetsinfo;b.assetsOtherInfo=e.assetsotherinfo;console.log(b.assetsOtherInfo);b.data=b.assetsInfo.assets;b.chartdata=[];b.assetchartincludeall=true;for(index=0;index<b.data.length;++index){if(b.data[index].extra==null){b.data[index].extra={};categoryid=0;categoryname="";subcategoryname="";riskname="";subcategories=b.assetsOtherInfo.subcategories;categoryid=0;riskid=-1;for(i=0;i<subcategories.length;++i){if(subcategories[i].subcategoryid==b.data[index].subcategoryid){subcategoryname=subcategories[i].subcategoryname;categoryid=subcategories[i].categoryid;riskid=subcategories[i].riskid;break}}categories=b.assetsOtherInfo.categories;for(i=0;i<categories.length;++i){if(categories[i].categoryid==categoryid){categoryname=categories[i].categoryname;break}}riskcategories=b.assetsOtherInfo.riskcategories;for(i=0;i<riskcategories.length;++i){if(riskcategories[i].riskid==riskid){riskname=riskcategories[i].riskname;break}}b.data[index].extra.categoryid=categoryid;b.data[index].extra.categoryname=categoryname;b.data[index].extra.subcategoryname=subcategoryname;b.data[index].extra.riskname=riskname}}b.selectedassets=function(){b.chartdata=f("filter")(b.data,{extra:{chartinclude:true}})};b.selectallassets=function(){for(index=0;index<b.data.length;++index){b.data[index].extra.chartinclude=b.assetchartincludeall}b.selectedassets()};b.nameFunction=function(){return function(h){return h.assetname}};b.ppuFunction=function(){return function(h){if(h.extra.dval==null){if(h.ppu!=null){h.extra.dval=h.ppu}else{h.extra.dval=0}h.extra.dval=h.extra.dval*h.units;h.extra.dval=h.extra.dval.toFixed(2)}return h.extra.dval}};b.getppu=b.ppuFunction();b.cppuFunction=function(){return function(h){if(h.extra.dcval==null){if(h.cppu!=null){h.extra.dcval=h.cppu}else{h.extra.dcval=0}h.extra.dcval=h.extra.dcval*h.units;h.extra.dcval=h.extra.dcval.toFixed(2)}return h.extra.dcval}};b.getcppu=b.cppuFunction();b.colorFunction=function(){return function(j,h){d=j.data;if(d==null){d=j}if(d.extra.color==null){if(d.color==""||d.color==null){d.extra.color="#"+Math.floor(Math.random()*16777215).toString(16)}else{d.extra.color=d.color}}return d.extra.color}};b.getcolor=b.colorFunction();b.getdefaultasset=function(){d={assetid:"0",subcategoryid:"",assetname:"",assetdescription:"",units:"",ppu:"",cppu:"",unitform:"",date:new Date().toISOString().slice(0,10),color:"",extra:{chartinclude:true}};return d};b.addrow=function(h){d=b.getdefaultasset();d.extra.dval=null;d.extra.dcval=null;d.extra.newrow=true;if(h==-1){b.data.push(d);h=b.data.length-1}else{b.data.splice(h,0,d)}b.entereditmode(h)};b.removerow=function(h){assetid=b.data[h].assetid;b.data.splice(h,1);b.selectedassets();if(assetid!="0"){data={assetid:assetid};b.removasset(data)}};b.removasset=function(h){g({method:"POST",url:"home/removeeasset",data:h,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(j){console.log("successfully removed data from server");a.$broadcast("assetsupdated","assetsController")})};b.addupdateasset=function(j,h){console.log(j);g({method:"POST",url:"home/addupdateasset",data:j,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(l){console.log("successfully sent data to server");if(l&&j.assetid=="0"){b.data[h].assetid=l.assetid}a.$broadcast("assetsupdated","assetsController")})};b.entereditmode=function(h){b.data[h].extra.editMode=true;d=angular.copy(b.data[h]);b.data[h].extra.copy=d};b.submitdefferredchanges=function(j,h){if(typeof j.date!="string"&&!(j.date instanceof String)){j.date=j.date.toISOString().slice(0,10)}j.extra.dval=null;j.extra.dcval=null;j.extra.color=null;j.extra.newrow=false;j.extra.editMode=false;b.data[h]=j;b.selectedassets();j=angular.copy(b.data[h]);delete j.extra;delete j.disabled;b.addupdateasset(j,h);console.log("submitting now")};b.submitchanges=function(h){d=b.data[h].extra.copy;entereddetails={categoryname:d.extra.categoryname,subcategoryname:d.extra.subcategoryname,riskname:b.assetsOtherInfo.riskcategories[0].riskname};if(d.extra.categoryname!=b.data[h].extra.categoryname||d.extra.subcategoryname!=b.data[h].extra.subcategoryname){categoryid=null;categories=b.assetsOtherInfo.categories;for(i=0;i<categories.length;++i){if(entereddetails.categoryname==categories[i].categoryname){categoryid=categories[i].categoryid;break}}if(categoryid==null){b.opencategorymodel(null,entereddetails,d,h)}else{subcategoryid=null;subcategories=b.assetsOtherInfo.subcategories;for(i=0;i<subcategories.length;++i){if(categoryid==subcategories[i].categoryid&&entereddetails.subcategoryname==subcategories[i].subcategoryname){subcategoryid=subcategories[i].subcategoryid;break}}if(subcategoryid==null){b.opencategorymodel(null,entereddetails,d,h)}else{d.subcategoryid=subcategoryid;b.submitdefferredchanges(d,h)}}}else{b.submitdefferredchanges(d,h)}};b.cancelchanges=function(h){if(b.data[h].extra.newrow==true){b.removerow(h)}else{delete b.data[h].extra.copy;b.data[h].extra.editMode=false;b.selectedassets()}console.log("cancelling now")};b.datepickopen=function(j,h){j.preventDefault();j.stopPropagation();b.data[h].extra.opened=true};b.opencategorymodel=function(l,h,m,j){modalInstance=c.open({template:categoryhtml,controller:categoryModelController,size:l,resolve:{categorydetails:function(){categoryInfo={entereddetails:h,assetsOtherInfo:b.assetsOtherInfo};return categoryInfo}}});modalInstance.result.then(function(n){m.subcategoryid=n.subcategoryid;m.extra.subcategoryname=n.subcategoryname;m.extra.categoryname=n.categoryname;b.submitdefferredchanges(m,j)},function(){})};b.selectallassets()}});app.controller("categoriesController",function(b,a,g,f,c,e){e.assetsotherinfodefferred.promise.then(function(h){return e.assetsinfodefferred.promise}).then(function(h){b.updateAssetsData(true)});b.$on("assetsupdated",function(h,j){b.updateAssetsData(false)});b.updateAssetsData=function(h){b.assetsInfo=e.assetsinfo;b.assetsOtherInfo=e.assetsotherinfo;console.log(b.assetsOtherInfo);b.assetsdata=b.assetsInfo.assets;b.chartdata=[];b.assetchartincludeall=true;b.data=b.assetsOtherInfo.categories;for(index=0;index<b.data.length;++index){if(b.data[index].extra==null){b.data[index].extra={};b.data[index].extra.showassets=false;b.data[index].extra.chartinclude=true}b.data[index].extra.dval=null;b.data[index].extra.dcval=null;b.data[index].extra.assets=[]}for(index=0;index<b.assetsdata.length;++index){categoryid=-1;categoryname="";if(b.assetsdata[index].extra==null){b.assetsdata[index].extra={};subcategoryname="";riskname="";subcategories=b.assetsOtherInfo.subcategories;categoryid=0;for(i=0;i<subcategories.length;++i){if(subcategories[i].subcategoryid==b.assetsdata[index].subcategoryid){subcategoryname=subcategories[i].subcategoryname;categoryid=subcategories[i].categoryid;riskid=subcategories[i].riskid;break}}riskcategories=b.assetsOtherInfo.riskcategories;for(i=0;i<riskcategories.length;++i){if(riskcategories[i].riskid==riskid){riskname=riskcategories[i].riskname;break}}b.data[index].extra.subcategoryname=subcategoryname;b.data[index].extra.riskname=riskname}if(categoryid==-1){subcategories=b.assetsOtherInfo.subcategories;categoryid=0;for(i=0;i<subcategories.length;++i){if(subcategories[i].subcategoryid==b.assetsdata[index].subcategoryid){categoryid=subcategories[i].categoryid;break}}}categories=b.data;for(i=0;i<categories.length;++i){if(categories[i].categoryid==categoryid){categoryname=categories[i].categoryname;categories[i].extra.assets.push(b.assetsdata[index]);break}}b.assetsdata[index].extra.categoryid=categoryid;b.assetsdata[index].extra.categoryname=categoryname}b.nameFunction=function(){return function(j){return j.categoryname}};b.getppu=function(l,j){if(l.extra.dval==null){if(l.ppu!=null){l.extra.dval=l.ppu}else{l.extra.dval=0}l.extra.dval=l.extra.dval*l.units;l.extra.dval=l.extra.dval.toFixed(2)}if(!j||l.extra.chartinclude){return l.extra.dval}else{return 0}};b.ppuFunction=function(){return function(j){return b.getppu(j,true)}};b.getcppu=function(l,j){if(l.extra.dcval==null){if(l.cppu!=null){l.extra.dcval=l.cppu}else{l.extra.dcval=0}l.extra.dcval=l.extra.dcval*l.units;l.extra.dcval=l.extra.dcval.toFixed(2)}if(!j||l.extra.chartinclude){return l.extra.dcval}else{return 0}};b.cppuFunction=function(){return function(j){return b.getcppu(j,true)}};b.getcatppu=function(l,j){if(l.extra.dval==null){l.extra.dval=0;l.extra.dval2=0;for(index=0;index<l.extra.assets.length;++index){l.extra.dval+=parseFloat(b.getppu(l.extra.assets[index],true));l.extra.dval2+=parseFloat(b.getppu(l.extra.assets[index],false))}}if(!j){return l.extra.dval2}else{if(l.extra.chartinclude){return l.extra.dval}else{return 0}}};b.catppuFunction=function(){return function(j){return b.getcatppu(j,true)}};b.getcatcppu=function(l,j){if(l.extra.dcval==null){l.extra.dcval=0;l.extra.dcval2=0;for(index=0;index<l.extra.assets.length;++index){l.extra.dcval+=parseFloat(b.getcppu(l.extra.assets[index],true));l.extra.dcval2+=parseFloat(b.getcppu(l.extra.assets[index],false))}}if(!j){return l.extra.dcval2}else{if(l.extra.chartinclude){return l.extra.dcval}else{return 0}}};b.catcppuFunction=function(){return function(j){return b.getcatcppu(j,true)}};b.colorFunction=function(){return function(l,j){d=l.data;if(d==null){d=l}if(d.extra.color==null){if(d.color==""||d.color==null){d.extra.color="#"+Math.floor(Math.random()*16777215).toString(16)}else{d.extra.color=d.color}}return d.extra.color}};b.getcolor=b.colorFunction();b.getdefaultasset=function(){d={assetid:"0",subcategoryid:"",assetname:"",assetdescription:"",units:"",ppu:"",cppu:"",unitform:"",date:new Date().toISOString().slice(0,10),color:"",extra:{chartinclude:true}};return d};b.selectedassets=function(){b.chartdata=f("filter")(b.data,{extra:{chartinclude:true}})};b.selectedchildassets=function(j){b.data[j].extra.dcval=null;b.data[j].extra.dval=null;b.selectedassets()};b.selectallcategories=function(j){for(index=0;index<b.data.length;++index){b.data[index].extra.chartinclude=b.assetchartincludeall;if(j){assets=b.data[index].extra.assets;b.data[index].extra.assetchartincludeall=b.assetchartincludeall;for(i=0;i<assets.length;++i){assets[i].extra.chartinclude=b.assetchartincludeall}}}b.selectedassets()};b.selectallassets=function(j){assets=b.data[j].extra.assets;for(i=0;i<assets.length;++i){assets[i].extra.chartinclude=b.data[j].extra.assetchartincludeall}b.data[j].extra.dcval=null;b.data[j].extra.dval=null;b.selectedassets()};b.datepickopen=function(l,m,j){l.preventDefault();l.stopPropagation();b.data[m].extra.assets[j].extra.opened=true};b.addrow=function(l,j){d=b.getdefaultasset();d.extra.dval=null;d.extra.dcval=null;d.extra.newrow=true;if(j==-1){b.data[l].extra.assets.push(d);j=b.data[l].extra.assets.length-1}else{b.data[l].extra.assets.splice(j,0,d)}b.entereditmode(l,j)};b.removerow=function(l,j){assetid=b.data[l].extra.assets[j].assetid;var m=b.data[l].extra.assets.splice(j,1);i=b.assetsdata.indexOf(m[0]);if(i>=0){b.assetsdata.splice(i,1)}b.selectedchildassets(l);if(assetid!="0"){data={assetid:assetid};b.removasset(data)}};b.removasset=function(j){g({method:"POST",url:"home/removeeasset",data:j,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(l){console.log("successfully removed data from server");a.$broadcast("assetsupdated","categoriesController")})};b.addupdateasset=function(m,l,j){console.log(m);g({method:"POST",url:"home/addupdateasset",data:m,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(n){console.log("successfully sent data to server");if(n&&m.assetid=="0"){b.data[l].extra.assets[j].assetid=n.assetid;b.assetsdata.push(b.data[l].extra.assets[j])}a.$broadcast("assetsupdated","categoriesController")})};b.entereditmode=function(l,j){b.data[l].extra.assets[j].extra.editMode=true;d=angular.copy(b.data[l].extra.assets[j]);b.data[l].extra.assets[j].extra.copy=d};b.submitdefferredchanges=function(m,l,j){if(typeof m.date!="string"&&!(m.date instanceof String)){m.date=m.date.toISOString().slice(0,10)}m.extra.dval=null;m.extra.dcval=null;m.extra.color=null;m.extra.newrow=false;m.extra.editMode=false;currentd=b.data[l].extra.assets[j];for(k in m){currentd[k]=m[k]}b.selectedassets();m=angular.copy(b.data[l].extra.assets[j]);delete m.extra;delete m.disabled;b.addupdateasset(m,l,j);console.log("submitting now")};b.submitchanges=function(l,j){d=b.data[l].extra.assets[j].extra.copy;entereddetails={categoryname:d.extra.categoryname,subcategoryname:d.extra.subcategoryname,riskname:b.assetsOtherInfo.riskcategories[0].riskname};if(d.extra.categoryname!=b.data[j].extra.categoryname||d.extra.subcategoryname!=b.data[j].extra.subcategoryname){categoryid=null;categories=b.assetsOtherInfo.categories;for(i=0;i<categories.length;++i){if(entereddetails.categoryname==categories[i].categoryname){categoryid=categories[i].categoryid;break}}if(categoryid==null){b.opencategorymodel(null,entereddetails,d,l,j)}else{subcategoryid=null;subcategories=b.assetsOtherInfo.subcategories;for(i=0;i<subcategories.length;++i){if(categoryid==subcategories[i].categoryid&&entereddetails.subcategoryname==subcategories[i].subcategoryname){subcategoryid=subcategories[i].subcategoryid;break}}if(subcategoryid==null){b.opencategorymodel(null,entereddetails,d,l,j)}else{d.subcategoryid=subcategoryid;b.submitdefferredchanges(d,l,j)}}}else{b.submitdefferredchanges(d,l,j)}};b.cancelchanges=function(l,j){if(b.data[l].extra.assets[j].extra.newrow==true){b.removerow(l,j)}else{delete b.data[l].extra.assets[j].extra.copy;b.data[l].extra.assets[j].extra.editMode=false;b.selectedchildassets()}console.log("cancelling now")};b.opencategorymodel=function(m,j,o,n,l){modalInstance=c.open({template:categoryhtml,controller:categoryModelController,size:m,resolve:{categorydetails:function(){categoryInfo={entereddetails:j,assetsOtherInfo:b.assetsOtherInfo};return categoryInfo}}});modalInstance.result.then(function(q){o.subcategoryid=q.subcategoryid;o.extra.subcategoryname=q.subcategoryname;o.extra.categoryname=q.categoryname;b.submitdefferredchanges(o,n,l)},function(){})};if(h){b.selectallcategories(h)}else{b.selectedassets()}}});app.controller("subcategoriesController",function(b,a,g,f,c,e){e.assetsotherinfodefferred.promise.then(function(h){return e.assetsinfodefferred.promise}).then(function(h){b.updateAssetsData(true)});b.$on("assetsupdated",function(h,j){b.updateAssetsData(false)});b.updateAssetsData=function(h){b.assetsInfo=e.assetsinfo;b.assetsOtherInfo=e.assetsotherinfo;console.log(b.assetsOtherInfo);b.assetsdata=b.assetsInfo.assets;b.chartdata=[];b.assetchartincludeall=true;b.data=b.assetsOtherInfo.subcategories;for(index=0;index<b.data.length;++index){if(b.data[index].extra==null){b.data[index].extra={};b.data[index].extra.showassets=false;b.data[index].extra.chartinclude=true}b.data[index].extra.dval=null;b.data[index].extra.dcval=null;b.data[index].extra.assets=[]}for(index=0;index<b.assetsdata.length;++index){dataAdded=false;if(b.assetsdata[index].extra==null){b.assetsdata[index].extra={};categoryid=0;categoryname="";subcategoryname="";riskname="";subcategories=b.assetsOtherInfo.subcategories;categoryid=0;for(i=0;i<subcategories.length;++i){if(subcategories[i].subcategoryid==b.assetsdata[index].subcategoryid){subcategoryname=subcategories[i].subcategoryname;categoryid=subcategories[i].categoryid;riskid=subcategories[i].riskid;subcategories[i].extra.assets.push(b.assetsdata[index]);dataAdded=true;break}}categories=b.assetsOtherInfo.categories;for(i=0;i<categories.length;++i){if(categories[i].categoryid==categoryid){categoryname=categories[i].categoryname;break}}riskcategories=b.assetsOtherInfo.riskcategories;for(i=0;i<riskcategories.length;++i){if(riskcategories[i].riskid==riskid){riskname=riskcategories[i].riskname;break}}b.data[index].extra.categoryid=categoryid;b.data[index].extra.categoryname=categoryname;b.data[index].extra.subcategoryname=subcategoryname;b.data[index].extra.riskname=riskname}if(!dataAdded){subcategories=b.data;subcategoryid=b.assetsdata[index].subcategoryid;for(i=0;i<subcategories.length;++i){if(subcategories[i].subcategoryid==subcategoryid){subcategories[i].extra.assets.push(b.assetsdata[index]);break}}}}b.nameFunction=function(){return function(j){return j.subcategoryname}};b.getppu=function(l,j){if(l.extra.dval==null){if(l.ppu!=null){l.extra.dval=l.ppu}else{l.extra.dval=0}l.extra.dval=l.extra.dval*l.units;l.extra.dval=l.extra.dval.toFixed(2)}if(!j||l.extra.chartinclude){return l.extra.dval}else{return 0}};b.ppuFunction=function(){return function(j){return b.getppu(j,true)}};b.getcppu=function(l,j){if(l.extra.dcval==null){if(l.cppu!=null){l.extra.dcval=l.cppu}else{l.extra.dcval=0}l.extra.dcval=l.extra.dcval*l.units;l.extra.dcval=l.extra.dcval.toFixed(2)}if(!j||l.extra.chartinclude){return l.extra.dcval}else{return 0}};b.cppuFunction=function(){return function(j){return b.getcppu(j,true)}};b.getsppu=function(l,j){if(l.extra.dval==null){l.extra.dval=0;l.extra.dval2=0;for(index=0;index<l.extra.assets.length;++index){l.extra.dval+=parseFloat(b.getppu(l.extra.assets[index],true));l.extra.dval2+=parseFloat(b.getppu(l.extra.assets[index],false))}}if(!j){return l.extra.dval2}else{if(l.extra.chartinclude){return l.extra.dval}else{return 0}}};b.sppuFunction=function(){return function(j){return b.getsppu(j,true)}};b.getscppu=function(l,j){if(l.extra.dcval==null){l.extra.dcval=0;l.extra.dcval2=0;for(index=0;index<l.extra.assets.length;++index){l.extra.dcval+=parseFloat(b.getcppu(l.extra.assets[index],true));l.extra.dcval2+=parseFloat(b.getcppu(l.extra.assets[index],false))}}if(!j){return l.extra.dcval2}else{if(l.extra.chartinclude){return l.extra.dcval}else{return 0}}};b.scppuFunction=function(){return function(j){return b.getscppu(j,true)}};b.colorFunction=function(){return function(l,j){d=l.data;if(d==null){d=l}if(d.extra.color==null){if(d.color==""||d.color==null){d.extra.color="#"+Math.floor(Math.random()*16777215).toString(16)}else{d.extra.color=d.color}}return d.extra.color}};b.getcolor=b.colorFunction();b.getdefaultasset=function(){d={assetid:"0",subcategoryid:"",assetname:"",assetdescription:"",units:"",ppu:"",cppu:"",unitform:"",date:new Date().toISOString().slice(0,10),color:"",extra:{chartinclude:true}};return d};b.selectedassets=function(){b.chartdata=f("filter")(b.data,{extra:{chartinclude:true}})};b.selectedchildassets=function(j){b.data[j].extra.dcval=null;b.data[j].extra.dval=null;b.selectedassets()};b.selectallsubcategories=function(j){for(index=0;index<b.data.length;++index){b.data[index].extra.chartinclude=b.assetchartincludeall;if(j){assets=b.data[index].extra.assets;b.data[index].extra.assetchartincludeall=b.assetchartincludeall;for(i=0;i<assets.length;++i){assets[i].extra.chartinclude=b.assetchartincludeall}}}b.selectedassets()};b.selectallassets=function(j){assets=b.data[j].extra.assets;for(i=0;i<assets.length;++i){assets[i].extra.chartinclude=b.data[j].extra.assetchartincludeall}b.data[j].extra.dcval=null;b.data[j].extra.dval=null;b.selectedassets()};b.datepickopen=function(l,m,j){l.preventDefault();l.stopPropagation();b.data[m].extra.assets[j].extra.opened=true};b.addrow=function(l,j){d=b.getdefaultasset();d.extra.dval=null;d.extra.dcval=null;d.extra.newrow=true;if(j==-1){b.data[l].extra.assets.push(d);j=b.data[l].extra.assets.length-1}else{b.data[l].extra.assets.splice(j,0,d)}b.entereditmode(l,j)};b.removerow=function(l,j){assetid=b.data[l].extra.assets[j].assetid;var m=b.data[l].extra.assets.splice(j,1);i=b.assetsdata.indexOf(m[0]);if(i>=0){b.assetsdata.splice(i,1)}b.selectedchildassets(l);if(assetid!="0"){data={assetid:assetid};b.removasset(data)}};b.removasset=function(j){g({method:"POST",url:"home/removeeasset",data:j,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(l){console.log("successfully removed data from server");a.$broadcast("assetsupdated","subcategoriesController")})};b.addupdateasset=function(m,l,j){console.log(m);g({method:"POST",url:"home/addupdateasset",data:m,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(n){console.log("successfully sent data to server");if(n&&m.assetid=="0"){b.data[l].extra.assets[j].assetid=n.assetid;b.assetsdata.push(b.data[l].extra.assets[j])}a.$broadcast("assetsupdated","subcategoriesController")})};b.entereditmode=function(l,j){b.data[l].extra.assets[j].extra.editMode=true;d=angular.copy(b.data[l].extra.assets[j]);b.data[l].extra.assets[j].extra.copy=d};b.submitdefferredchanges=function(m,l,j){if(typeof m.date!="string"&&!(m.date instanceof String)){m.date=m.date.toISOString().slice(0,10)}m.extra.dval=null;m.extra.dcval=null;m.extra.color=null;m.extra.newrow=false;m.extra.editMode=false;currentd=b.data[l].extra.assets[j];for(k in m){currentd[k]=m[k]}b.selectedassets();m=angular.copy(b.data[l].extra.assets[j]);delete m.extra;delete m.disabled;b.addupdateasset(m,l,j);console.log("submitting now")};b.submitchanges=function(l,j){d=b.data[l].extra.assets[j].extra.copy;entereddetails={categoryname:d.extra.categoryname,subcategoryname:d.extra.subcategoryname,riskname:b.assetsOtherInfo.riskcategories[0].riskname};if(d.extra.categoryname!=b.data[j].extra.categoryname||d.extra.subcategoryname!=b.data[j].extra.subcategoryname){categoryid=null;categories=b.assetsOtherInfo.categories;for(i=0;i<categories.length;++i){if(entereddetails.categoryname==categories[i].categoryname){categoryid=categories[i].categoryid;break}}if(categoryid==null){b.opencategorymodel(null,entereddetails,d,l,j)}else{subcategoryid=null;subcategories=b.assetsOtherInfo.subcategories;for(i=0;i<subcategories.length;++i){if(categoryid==subcategories[i].categoryid&&entereddetails.subcategoryname==subcategories[i].subcategoryname){subcategoryid=subcategories[i].subcategoryid;break}}if(subcategoryid==null){b.opencategorymodel(null,entereddetails,d,l,j)}else{d.subcategoryid=subcategoryid;b.submitdefferredchanges(d,l,j)}}}else{b.submitdefferredchanges(d,l,j)}};b.cancelchanges=function(l,j){if(b.data[l].extra.assets[j].extra.newrow==true){b.removerow(l,j)}else{delete b.data[l].extra.assets[j].extra.copy;b.data[l].extra.assets[j].extra.editMode=false;b.selectedchildassets()}console.log("cancelling now")};b.opencategorymodel=function(m,j,o,n,l){modalInstance=c.open({template:categoryhtml,controller:categoryModelController,size:m,resolve:{categorydetails:function(){categoryInfo={entereddetails:j,assetsOtherInfo:b.assetsOtherInfo};return categoryInfo}}});modalInstance.result.then(function(q){o.subcategoryid=q.subcategoryid;o.extra.subcategoryname=q.subcategoryname;o.extra.categoryname=q.categoryname;b.submitdefferredchanges(o,n,l)},function(){})};if(h){b.selectallsubcategories(h)}else{b.selectedassets()}}});app.controller("riskbasedassetsController",function(b,a,g,f,c,e){e.assetsotherinfodefferred.promise.then(function(h){return e.assetsinfodefferred.promise}).then(function(h){b.updateAssetsData(true)});b.$on("assetsupdated",function(h,j){b.updateAssetsData(false)});b.updateAssetsData=function(h){b.assetsInfo=e.assetsinfo;b.assetsOtherInfo=e.assetsotherinfo;console.log(b.assetsOtherInfo);b.assetsdata=b.assetsInfo.assets;b.chartdata=[];b.assetchartincludeall=true;b.data=b.assetsOtherInfo.riskcategories;for(index=0;index<b.data.length;++index){if(b.data[index].extra==null){b.data[index].extra={};b.data[index].extra.showassets=false}b.data[index].extra.dval=null;b.data[index].extra.dcval=null;b.data[index].extra.assets=[]}for(index=0;index<b.assetsdata.length;++index){riskid=-1;if(b.assetsdata[index].extra==null){b.assetsdata[index].extra={};categoryid=0;categoryname="";subcategoryname="";riskname="";subcategories=b.assetsOtherInfo.subcategories;categoryid=0;for(i=0;i<subcategories.length;++i){if(subcategories[i].subcategoryid==b.assetsdata[index].subcategoryid){subcategoryname=subcategories[i].subcategoryname;categoryid=subcategories[i].categoryid;riskid=subcategories[i].riskid;break}}categories=b.assetsOtherInfo.categories;for(i=0;i<categories.length;++i){if(categories[i].categoryid==categoryid){categoryname=categories[i].categoryname;break}}b.assetsdata[index].extra.categoryid=categoryid;b.assetsdata[index].extra.categoryname=categoryname;b.assetsdata[index].extra.subcategoryname=subcategoryname}if(riskid==-1){subcategories=b.assetsOtherInfo.subcategories;for(i=0;i<subcategories.length;++i){if(subcategories[i].subcategoryid==b.assetsdata[index].subcategoryid){riskid=subcategories[i].riskid;break}}}riskcategories=b.data;for(i=0;i<riskcategories.length;++i){if(riskcategories[i].riskid==riskid){riskname=riskcategories[i].riskname;riskcategories[i].extra.assets.push(b.assetsdata[index]);break}}b.assetsdata[index].extra.riskname=riskname}b.nameFunction=function(){return function(j){return j.riskname+" Risk"}};b.getppu=function(l,j){if(l.extra.dval==null){if(l.ppu!=null){l.extra.dval=l.ppu}else{l.extra.dval=0}l.extra.dval=l.extra.dval*l.units;l.extra.dval=l.extra.dval.toFixed(2)}if(!j||l.extra.chartinclude){return l.extra.dval}else{return 0}};b.ppuFunction=function(){return function(j){return b.getppu(j,true)}};b.getcppu=function(l,j){if(l.extra.dcval==null){if(l.cppu!=null){l.extra.dcval=l.cppu}else{l.extra.dcval=0}l.extra.dcval=l.extra.dcval*l.units;l.extra.dcval=l.extra.dcval.toFixed(2)}if(!j||l.extra.chartinclude){return l.extra.dcval}else{return 0}};b.cppuFunction=function(){return function(j){return b.getcppu(j,true)}};b.getrppu=function(l,j){if(l.extra.dval==null){l.extra.dval=0;l.extra.dval2=0;for(index=0;index<l.extra.assets.length;++index){l.extra.dval+=parseFloat(b.getppu(l.extra.assets[index],true));l.extra.dval2+=parseFloat(b.getppu(l.extra.assets[index],false))}}if(!j){return l.extra.dval2}else{if(l.extra.chartinclude){return l.extra.dval}else{return 0}}};b.rppuFunction=function(){return function(j){return b.getrppu(j,true)}};b.getrcppu=function(l,j){if(l.extra.dcval==null){l.extra.dcval=0;l.extra.dcval2=0;for(index=0;index<l.extra.assets.length;++index){l.extra.dcval+=parseFloat(b.getcppu(l.extra.assets[index],true));l.extra.dcval2+=parseFloat(b.getcppu(l.extra.assets[index],false))}}if(!j){return l.extra.dcval2}else{if(l.extra.chartinclude){return l.extra.dcval}else{return 0}}};b.rcppuFunction=function(){return function(j){return b.getrcppu(j,true)}};b.colorFunction=function(){return function(l,j){d=l.data;if(d==null){d=l}if(d.extra.color==null){if(d.color==""||d.color==null){d.extra.color="#"+Math.floor(Math.random()*16777215).toString(16)}else{d.extra.color=d.color}}return d.extra.color}};b.getcolor=b.colorFunction();b.getdefaultasset=function(){d={assetid:"0",subcategoryid:"",assetname:"",assetdescription:"",units:"",ppu:"",cppu:"",unitform:"",date:new Date().toISOString().slice(0,10),color:"",extra:{chartinclude:true}};return d};b.selectedassets=function(){b.chartdata=f("filter")(b.data,{extra:{chartinclude:true}})};b.selectedchildassets=function(j){b.data[j].extra.dcval=null;b.data[j].extra.dval=null;b.selectedassets()};b.selectallrisks=function(j){for(index=0;index<b.data.length;++index){b.data[index].extra.chartinclude=b.assetchartincludeall;if(j){assets=b.data[index].extra.assets;b.data[index].extra.assetchartincludeall=b.assetchartincludeall;for(i=0;i<assets.length;++i){assets[i].extra.chartinclude=b.assetchartincludeall}}}b.selectedassets()};b.selectallassets=function(j){assets=b.data[j].extra.assets;for(i=0;i<assets.length;++i){assets[i].extra.chartinclude=b.data[j].extra.assetchartincludeall}b.data[j].extra.dcval=null;b.data[j].extra.dval=null;b.selectedassets()};b.datepickopen=function(l,m,j){l.preventDefault();l.stopPropagation();b.data[m].extra.assets[j].extra.opened=true};b.addrow=function(l,j){d=b.getdefaultasset();d.extra.dval=null;d.extra.dcval=null;d.extra.newrow=true;if(j==-1){b.data[l].extra.assets.push(d);j=b.data[l].extra.assets.length-1}else{b.data[l].extra.assets.splice(j,0,d)}b.entereditmode(l,j)};b.removerow=function(l,j){assetid=b.data[l].extra.assets[j].assetid;var m=b.data[l].extra.assets.splice(j,1);i=b.assetsdata.indexOf(m[0]);if(i>=0){b.assetsdata.splice(i,1)}b.selectedchildassets(l);if(assetid!="0"){data={assetid:assetid};b.removasset(data)}};b.removasset=function(j){g({method:"POST",url:"home/removeeasset",data:j,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(l){console.log("successfully removed data from server");a.$broadcast("assetsupdated","riskbasedassetsController")})};b.addupdateasset=function(m,l,j){console.log(m);g({method:"POST",url:"home/addupdateasset",data:m,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(n){console.log("successfully sent data to server");if(n&&m.assetid=="0"){b.data[l].extra.assets[j].assetid=n.assetid;b.assetsdata.push(b.data[l].extra.assets[j])}a.$broadcast("assetsupdated","riskbasedassetsController")})};b.entereditmode=function(l,j){b.data[l].extra.assets[j].extra.editMode=true;d=angular.copy(b.data[l].extra.assets[j]);b.data[l].extra.assets[j].extra.copy=d};b.submitdefferredchanges=function(m,l,j){if(typeof m.date!="string"&&!(m.date instanceof String)){m.date=m.date.toISOString().slice(0,10)}m.extra.dval=null;m.extra.dcval=null;m.extra.color=null;m.extra.newrow=false;m.extra.editMode=false;currentd=b.data[l].extra.assets[j];for(k in m){currentd[k]=m[k]}b.selectedassets();m=angular.copy(b.data[l].extra.assets[j]);delete m.extra;delete m.disabled;b.addupdateasset(m,l,j);console.log("submitting now")};b.submitchanges=function(l,j){d=b.data[l].extra.assets[j].extra.copy;entereddetails={categoryname:d.extra.categoryname,subcategoryname:d.extra.subcategoryname,riskname:b.data[l].riskname};if(d.extra.categoryname!=b.data[j].extra.categoryname||d.extra.subcategoryname!=b.data[j].extra.subcategoryname){categoryid=null;categories=b.assetsOtherInfo.categories;for(i=0;i<categories.length;++i){if(entereddetails.categoryname==categories[i].categoryname){categoryid=categories[i].categoryid;break}}if(categoryid==null){b.opencategorymodel(null,entereddetails,d,l,j)}else{subcategoryid=null;subcategories=b.assetsOtherInfo.subcategories;for(i=0;i<subcategories.length;++i){if(categoryid==subcategories[i].categoryid&&entereddetails.subcategoryname==subcategories[i].subcategoryname){subcategoryid=subcategories[i].subcategoryid;break}}if(subcategoryid==null){b.opencategorymodel(null,entereddetails,d,l,j)}else{d.subcategoryid=subcategoryid;b.submitdefferredchanges(d,l,j)}}}else{b.submitdefferredchanges(d,l,j)}};b.cancelchanges=function(l,j){if(b.data[l].extra.assets[j].extra.newrow==true){b.removerow(l,j)}else{delete b.data[l].extra.assets[j].extra.copy;b.data[l].extra.assets[j].extra.editMode=false;b.selectedchildassets()}console.log("cancelling now")};b.opencategorymodel=function(m,j,o,n,l){modalInstance=c.open({template:categoryhtml,controller:categoryModelController,size:m,resolve:{categorydetails:function(){categoryInfo={entereddetails:j,assetsOtherInfo:b.assetsOtherInfo};return categoryInfo}}});modalInstance.result.then(function(q){o.subcategoryid=q.subcategoryid;o.extra.subcategoryname=q.subcategoryname;o.extra.categoryname=q.categoryname;b.submitdefferredchanges(o,n,l)},function(){})};if(h){b.selectallrisks(h)}else{b.selectedassets()}}});app.controller("homeController",function(a,b){a.getAssetsData=function(){b.getAssetsOtherInfo();b.getAssetsInfo();b.assetsotherinfodefferred.promise.then(function(c){return b.assetsinfodefferred.promise}).then(function(c){a.updateNetAssetsData()})};a.$on("assetsupdated",function(c,e){a.updateNetAssetsData()});a.updateNetAssetsData=function(){assetsdata=b.assetsinfo.assets;cppuFunction=function(c){if(c.cppu!=null){dcval=c.cppu}else{dcval=0}dcval=dcval*c.units;return dcval};netassets=0;for(i=0;i<assetsdata.length;++i){netassets+=cppuFunction(assetsdata[i])}a.netassets=netassets.toFixed(2)};a.tabselected=function(){for(i=0;i<nv.graphs.length;++i){nv.graphs[i].update()}};a.getAssetsData()});app.controller("welcomeController",function(a,b){a.gotohome=function(){b.path("/home")}});app.controller("loginController",function(a,e,c,b){a.formData={};a.formData.name="";a.formData.password="";a.processForm=function(){a.errorName="";a.errorPassword="";e({method:"POST",url:"login/loginUser",data:a.formData,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(f){if(f){b.updateSession();if(!f.success){a.errorName=f.errors.name;a.errorPassword=f.errors.password;a.message=f.errors.message}else{c.path("/")}}})}});app.controller("userController",function(b,j,a,c,h,e,f){function g(){a.timeCount--;if(a.timeCount>0){a.alertInfo="You will be directed to Welcome / Login page in "+b.timeCount+" seconds";c(g,1000)}else{a.alertInfo="";h.path("/")}}b.updatePassword=false;b.$watch("updatePassword",function(l){console.log("watch updatePassword");console.log(l);if(!l){console.log("clearing password");b.formData.password="";b.formData.password2="";b.formData.currentpassword=""}});b.formData={};b.showUser=true;b.currentpassword=true;if(!e.data.configured){b.formData.name="admin";b.formData.displayname="Admin";b.register=false;b.setPassword=true;b.message="Provide password for admin";baseurlapi="user/firstrun/configure"}else{if(f.type==="register"){b.formData.name="";b.formData.displayname="";b.register=true;b.setPassword=false;baseurlapi="user/register/new"}else{if(f.type==="update"){b.formData.name=e.currentuser.username;b.formData.displayname=e.currentuser.displayname;b.formData.admin=e.currentuser.admin;b.register=false;b.setPassword=false;b.currentPassword=e.data.userinfo["username"]==e.currentuser.username;baseurlapi="user/update"}}}b.setPassword=b.setPassword&&(!b.register);b.showUpdateSettings=!b.register&&!b.setPassword;b.disableUser=!b.register;b.disableDisplayName=!(b.showUpdateSettings||b.register);b.processForm=function(){b.errorName="";b.errorCurrentPassword="";b.errorPassword="";b.errorPassword2="";b.alertMessage="";if((b.updatePassword||b.register)&&b.formData.password!==b.formData.password2){b.errorPassword2="Passwords do not match. Please try again"}else{urlapi=baseurlapi;if(f.type==="update"){if(b.updatePassword){urlapi=urlapi+"/all"}else{urlapi=urlapi+"/displayname"}}console.log(b.formData.password);j({method:"POST",url:urlapi,data:b.formData,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(l){str=[];for(p in l){str.push(encodeURIComponent(p)+"="+encodeURIComponent(l[p]))}return str.join("&")}}).success(function(l){if(l){if(!l.success){b.errorName=l.errors.name;b.errorPassword=l.errors.password;b.errorCurrentPassword=l.errors.currentpassword;b.alertMessage=l.errors.message;b.alertError=true}else{b.alertMessage=l.message;b.alertError=false;if(b.register||b.currentPassword){b.formData.admin="false"}b.formData.password="";b.formData.password2="";b.formData.currentpassword="";e.updateSession();if(!e.data.configured){a.timeCount=5;a.alertInfo="You will be directed to Welcome / Login page in "+b.timeCount+" seconds";c(g,1000)}}}})}}});