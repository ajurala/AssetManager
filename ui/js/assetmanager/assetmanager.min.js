var app=angular.module("AssetManager",["ngRoute","ui.bootstrap","nvd3ChartDirectives","colorpicker.module"]);
app.factory("Session",["$http","$q",function(a,e){var c={data:{configured:!0,loggedin:!1,userinfo:{userid:"-1",username:"unknown",displayname:"Unknown",accessroles:[-1]}},currentuser:{username:"unknown",displayname:"unknown",admin:!1},defferred:e.defer(),updateSession:function(){c.defferred=e.defer();a.post("login/get_login_info").then(function(a){c.data=a.data;c.currentuser.username=c.data.userinfo.username;c.currentuser.displayname=c.data.userinfo.displayname;c.currentuser.admin=c.data.userinfo.admin;
c.defferred.resolve()},function(a){c.defferred.resolve()})},assetsotherinfo:{},assetsotherinfodefferred:e.defer(),getAssetsOtherInfo:function(){c.assetsotherinfodefferred=e.defer();a.post("home/getotherinfo").then(function(a){c.assetsotherinfo=a.data;c.assetsotherinfodefferred.resolve()},function(a){c.assetsotherinfodefferred.resolve()})},assetsinfo:{},assetsinfodefferred:e.defer(),getAssetsInfo:function(){c.assetsinfodefferred=e.defer();a.post("home/getnetassets").then(function(a){c.assetsinfo=a.data;
c.assetsinfodefferred.resolve()},function(a){c.assetsinfodefferred.resolve()})},initialassstsupdate:e.defer()};c.assetsotherinfodefferred.resolve();c.assetsinfodefferred.resolve();c.updateSession();return c}]);
app.config(["$routeProvider","$locationProvider",function(a,e){a.when("/home",{controller:"homeController",templateUrl:"ui/partials/home.html",resolve:{toAllowOrNot:checkStatus}}).when("/login",{controller:"loginController",templateUrl:"ui/partials/login.html",resolve:{toAllowOrNot:checkStatus}}).when("/user/users",{templateUrl:"ui/partials/usersinfo.html",resolve:{toAllowOrNot:checkStatus}}).when("/user/:type",{controller:"userController",templateUrl:"ui/partials/user.html",resolve:{toAllowOrNot:checkStatus}}).when("/user",
{templateUrl:"ui/partials/userprofile.html",resolve:{toAllowOrNot:checkStatus}}).when("/",{controller:"welcomeController",templateUrl:"ui/partials/welcome.html",resolve:{toAllowOrNot:checkStatus}}).otherwise({redirectTo:"/"});e.html5Mode(!0)}]);app.directive("assets",function(){return{restrict:"E",templateUrl:"ui/partials/assets.html"}});app.directive("categories",function(){return{restrict:"E",templateUrl:"ui/partials/categories.html"}});
app.directive("subcategories",function(){return{restrict:"E",templateUrl:"ui/partials/subcategories.html"}});app.directive("riskbasedassets",function(){return{restrict:"E",templateUrl:"ui/partials/riskbasedassets.html"}});app.directive("customgroups",function(){return{restrict:"E",templateUrl:"ui/partials/customgroups.html"}});_MS_PER_DAY=864E5;
function transformURIRequest(a){str=[];for(p in a)str.push(encodeURIComponent(p)+"="+encodeURIComponent(a[p]));result=str.join("&");console.log(result);return result}
function check_login(a,e,c,g){function h(a){"/user/update"!==e.path()&&g.data.userinfo.username!=g.currentuser.username&&(g.currentuser.username=g.data.userinfo.username,g.currentuser.displayname=g.data.userinfo.displayname);a.resolve()}a=a.defer();data=g.data;data.configured?"/user/firstrun"===e.path()?(a.reject(),e.path("/")):"/login"===e.path()?data.loggedin?(a.reject(),e.path("/")):h(a):data.loggedin?h(a):(a.reject(),e.path("/login")):"/user/firstrun"===e.path()?h(a):(a.reject(),e.path("/user/firstrun"));
return a.promise}checkStatus=["$q","$location","$http","Session",function(a,e,c,g){return g.defferred.promise.then(function(a){return g.assetsotherinfodefferred.promise}).then(function(a){return g.assetsinfodefferred.promise}).then(function(h){return check_login(a,e,c,g)})}];
categoryModelController=["$scope","$rootScope","$modalInstance","$http","categorydetails","Session",function(a,e,c,g,h,l){a.categorydetails=h;a.assetsOtherInfo=h.assetsOtherInfo;a.categorydetails.entereddetails.categorycolor="#"+Math.floor(16777215*Math.random()).toString(16);a.categorydetails.entereddetails.subcategorycolor="#"+Math.floor(16777215*Math.random()).toString(16);a.ok=function(){a.riskError="";a.knownCombinationError="";foundcombination=!1;subcategories=a.assetsOtherInfo.subcategories;
for(i=0;i<subcategories.length;++i){if(a.categorydetails.entereddetails.subcategoryname==subcategories[i].subcategoryname)for(subcategoryid=subcategories[i].subcategoryid,categoryid=subcategories[i].categoryid,categories=a.assetsOtherInfo.categories,i=0;i<categories.length;++i)if(categories[i].categoryid==categoryid&&a.categorydetails.entereddetails.categoryname==categories[i].categoryname){foundcombination=!0;break}if(foundcombination)break}riskname=a.categorydetails.entereddetails.riskname;if(foundcombination||
null==riskname)foundcombination&&(a.knownCombinationError="Asset type and Sub-Asset type combination already exists. Provide different combination"),null==riskname&&(a.riskError="No such risk category. Choose on in the list");else{categoryid="0";categories=a.assetsOtherInfo.categories;for(i=0;i<categories.length;++i)if(a.categorydetails.entereddetails.categoryname==categories[i].categoryname){categoryid=categories[i].categoryid;break}riskid=subcategoryid="0";riskcategories=a.assetsOtherInfo.riskcategories;
for(i=0;i<riskcategories.length;++i)if(riskcategories[i].riskname==riskname){riskid=riskcategories[i].riskid;break}d={};"0"==categoryid&&(category={categoryname:a.categorydetails.entereddetails.categoryname,color:a.categorydetails.entereddetails.categorycolor},d.category=angular.toJson(category));subcategory={categoryid:categoryid,riskid:riskid,subcategoryname:a.categorydetails.entereddetails.subcategoryname,currentpriceperunit:a.categorydetails.entereddetails.currentpriceperunit,unitform:a.categorydetails.entereddetails.unitform,
color:a.categorydetails.entereddetails.subcategorycolor};d.subcategory=angular.toJson(subcategory);g({method:"POST",url:"home/addcategorysubcategory",data:d,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(e){console.log("successfully sent data to server for category");e&&(entereddetails={categoryname:a.categorydetails.entereddetails.categoryname,subcategoryname:a.categorydetails.entereddetails.subcategoryname,subcategoryid:e.subcategorydetails.subcategoryid},
h=e.categorydetails,subcategorydetails=e.subcategorydetails,null!=h&&l.assetsotherinfo.categories.push(h),l.assetsotherinfo.subcategories.push(subcategorydetails),c.close(entereddetails))})}};a.cancel=function(){c.dismiss("cancel")}}];
groupModelController=["$scope","$rootScope","$modalInstance","$http","groupdetails","Session",function(a,e,c,g,h,l){a.groupdetails=h;a.assetsOtherInfo=h.assetsOtherInfo;a.groupdetails.color="#"+Math.floor(16777215*Math.random()).toString(16);a.ok=function(){a.groupError="";found=!1;customgroups=a.assetsOtherInfo.customgroups;for(i=0;i<customgroups.length;++i)if(a.groupdetails.groupname==customgroups[i].groupname){found=!0;break}found?a.groupError="Group name already exists. Provide a new group name":
(d={},d.groupname=a.groupdetails.groupname,d.color=a.groupdetails.color,g({method:"POST",url:"home/addcustomgroup",data:d,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(a){console.log("successfully sent data to server for group");a&&(h={groupid:a.groupid,groupname:a.groupname,color:a.color},a.extra={},a.extra.assets=[],a.extra.chartinclude=!0,l.assetsotherinfo.customgroups.push(a),c.close(h))}))};a.cancel=function(){c.dismiss("cancel")}}];
app.controller("navbarController",["$scope","$http","$location","$window","$rootScope","Session",function(a,e,c,g,h,l){a.isCollapsed=!0;a.$watch(function(){return l.data},function(a){h.loggedin=a.loggedin;h.username=a.userinfo.username;h.displayname=a.userinfo.displayname;h.admin=a.userinfo.admin});a.logout=function(){e({method:"POST",url:"login/logoutUser"}).success(function(){l.updateSession();g.location.href=""})}}]);
app.controller("userprofileController",["$scope","$location",function(a,e){a.editUserProfile=function(){e.path("/user/update")}}]);app.controller("usersController",["$scope","$http","$location","Session",function(a,e,c,g){a.getUsersInfo=function(){e({method:"POST",url:"user/users/all"}).success(function(c){c&&(a.users=c)})};a.editUserProfile=function(a,e,m){g.currentuser.username=a;g.currentuser.displayname=e;g.currentuser.admin=m;c.path("/user/update")};a.getUsersInfo()}]);
app.controller("groupingsController",["$scope","$rootScope","$http","$filter","$modal","Session",function(a,e,c,g,h,l){l.assetsotherinfodefferred.promise.then(function(a){return l.assetsinfodefferred.promise}).then(function(a){return l.initialassstsupdate.promise}).then(function(c){a.updateAssetsData(!0)});console.log("how ya doing "+a.groupingtype);a.$on("assetsupdated",function(c,b){a.updateAssetsData(!1)});a.updateAssetsData=function(m){a.assetsInfo=l.assetsinfo;a.assetsOtherInfo=l.assetsotherinfo;
console.log(a.assetsOtherInfo);a.assetsdata=a.assetsInfo.assets;a.chartdata=[];a.assetchartincludeall=!0;if("customgroups"==a.groupingtype)a.data=a.assetsOtherInfo.customgroups;else if("riskcategories"==a.groupingtype)a.data=a.assetsOtherInfo.riskcategories;else if("subcategories"==a.groupingtype)a.data=a.assetsOtherInfo.subcategories;else if("categories"==a.groupingtype)a.data=a.assetsOtherInfo.categories;else{console.log("Error: Invalid groupingtype provided");return}for(index=0;index<a.data.length;++index)null==
a.data[index].extra&&(a.data[index].extra={},a.data[index].extra.showassets=!1,a.data[index].extra.chartinclude=!0),a.data[index].extra.dval=null,a.data[index].extra.dcval=null,a.data[index].extra.assets=[];for(index=0;index<a.assetsdata.length;++index)for(groupingdata=a.data,i=0;i<groupingdata.length;++i){if("customgroups"==a.groupingtype)groupingid=groupingdata[i].groupid,assetsgroupingid=a.assetsdata[index].customgroupid;else if("riskcategories"==a.groupingtype)for(groupingid=groupingdata[i].riskid,
subcategories=a.assetsOtherInfo.subcategories,j=0;j<subcategories.length;++j){if(subcategories[j].subcategoryid==a.assetsdata[index].subcategoryid){assetsgroupingid=subcategories[j].riskid;break}}else if("subcategories"==a.groupingtype)groupingid=groupingdata[i].subcategoryid,assetsgroupingid=a.assetsdata[index].subcategoryid;else if("categories"==a.groupingtype)for(groupingid=groupingdata[i].categoryid,subcategories=a.assetsOtherInfo.subcategories,j=0;j<subcategories.length;++j)if(subcategories[j].subcategoryid==
a.assetsdata[index].subcategoryid){assetsgroupingid=subcategories[j].categoryid;break}if(groupingid==assetsgroupingid){groupingdata[i].extra.assets.push(a.assetsdata[index]);break}}a.nameFunction=function(){return function(b){if("customgroups"==a.groupingtype)return b.groupname;if("riskcategories"==a.groupingtype)return b.riskname;if("subcategories"==a.groupingtype)return b.subcategoryname;if("categories"==a.groupingtype)return b.categoryname}};a.getppu=function(a,f){null==a.extra.dval&&(a.extra.dval=
null!=a.ppu?a.ppu:0,a.extra.dval*=a.units,a.extra.dval=a.extra.dval.toFixed(2));return!f||a.extra.chartinclude?a.extra.dval:0};a.ppuFunction=function(){return function(b){return a.getppu(b,!0)}};a.getcppu=function(a,f){null==a.extra.dcval&&(a.extra.dcval=null!=a.cppu?a.cppu:0,a.extra.dcval*=a.units,a.extra.dcval=a.extra.dcval.toFixed(2));return!f||a.extra.chartinclude?a.extra.dcval:0};a.cppuFunction=function(){return function(b){return a.getcppu(b,!0)}};a.getgppu=function(b,f){if(null==b.extra.dval)for(b.extra.dval=
0,index=b.extra.dval2=0;index<b.extra.assets.length;++index)b.extra.dval+=parseFloat(a.getppu(b.extra.assets[index],!0)),b.extra.dval2+=parseFloat(a.getppu(b.extra.assets[index],!1));return f?b.extra.chartinclude?b.extra.dval:0:b.extra.dval2};a.gppuFunction=function(){return function(b){return a.getgppu(b,!0)}};a.getgcppu=function(b,f){if(null==b.extra.dcval)for(b.extra.dcval=0,index=b.extra.dcval2=0;index<b.extra.assets.length;++index)b.extra.dcval+=parseFloat(a.getcppu(b.extra.assets[index],!0)),
b.extra.dcval2+=parseFloat(a.getcppu(b.extra.assets[index],!1));return f?b.extra.chartinclude?b.extra.dcval:0:b.extra.dcval2};a.gcppuFunction=function(){return function(b){return a.getgcppu(b,!0)}};a.colorFunction=function(){return function(a,f){d=a.data;null==d&&(d=a);null==d.extra.color&&(d.extra.color=""==d.color||null==d.color?"#"+Math.floor(16777215*Math.random()).toString(16):d.color);return d.extra.color}};a.getcolor=a.colorFunction();a.getdefaultasset=function(){return d={assetid:"0",subcategoryid:"",
assetname:"",assetdescription:"",units:"",ppu:"",cppu:"",unitform:"",date:(new Date).toISOString().slice(0,10),color:"#"+Math.floor(16777215*Math.random()).toString(16),extra:{chartinclude:!0}}};a.getcagr=function(b){investeddate=new Date(b.date);currentdate=new Date;years=(currentdate-investeddate)/_MS_PER_DAY/365;days=(currentdate-investeddate)/_MS_PER_DAY;if(30>days)return"NA";cppu=parseFloat(a.getcppu(b,!1));ppu=parseFloat(a.getppu(b,!1));cagr=100*(Math.pow(cppu/ppu,1/years)-1);return cagr.toFixed(2)};
a.selectedassets=function(){a.chartdata=g("filter")(a.data,{extra:{chartinclude:!0}})};a.selectedchildassets=function(b){a.data[b].extra.dcval=null;a.data[b].extra.dval=null;a.selectedassets()};a.selectallgroupings=function(b){for(index=0;index<a.data.length;++index)if(a.data[index].extra.chartinclude=a.assetchartincludeall,b)for(assets=a.data[index].extra.assets,a.data[index].extra.assetchartincludeall=a.assetchartincludeall,i=0;i<assets.length;++i)assets[i].extra.chartinclude=a.assetchartincludeall;
a.selectedassets()};a.selectallassets=function(b){assets=a.data[b].extra.assets;for(i=0;i<assets.length;++i)assets[i].extra.chartinclude=a.data[b].extra.assetchartincludeall;a.data[b].extra.dcval=null;a.data[b].extra.dval=null;a.selectedassets()};a.datepickopen=function(b,f,c){b.preventDefault();b.stopPropagation();a.data[f].extra.assets[c].extra.opened=!0};a.addrow=function(b,f){d=a.getdefaultasset();d.extra.dval=null;d.extra.dcval=null;d.extra.newrow=!0;-1==f?(a.data[b].extra.assets.push(d),f=a.data[b].extra.assets.length-
1):a.data[b].extra.assets.splice(f,0,d);a.entereditmode(b,f)};a.removerow=function(b,f){assetid=a.data[b].extra.assets[f].assetid;var c=a.data[b].extra.assets.splice(f,1);i=a.assetsdata.indexOf(c[0]);0<=i&&a.assetsdata.splice(i,1);a.selectedchildassets(b);"0"!=assetid&&(data={assetid:assetid},a.removasset(data))};a.removasset=function(a){c({method:"POST",url:"home/removeeasset",data:a,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(a){console.log("successfully removed data from server");
e.$broadcast("assetsupdated","groupingsController")})};a.addupdateasset=function(b,f,h){console.log(b);c({method:"POST",url:"home/addupdateasset",data:b,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(c){console.log("successfully sent data to server");c&&"0"==b.assetid&&(a.data[f].extra.assets[h].assetid=c.assetid,a.assetsdata.push(a.data[f].extra.assets[h]));e.$broadcast("assetsupdated","groupingsController")})};a.entereditmode=
function(b,f){a.data[b].extra.assets[f].extra.editMode=!0;d=angular.copy(a.data[b].extra.assets[f]);a.data[b].extra.assets[f].extra.copy=d};a.submitdefferredchanges=function(b,f,c){"string"==typeof b.date||b.date instanceof String||(b.date=b.date.toISOString().slice(0,10));b.extra.dval=null;b.extra.dcval=null;b.extra.color=null;b.extra.newrow=!1;b.extra.editMode=!1;currentd=a.data[f].extra.assets[c];for(k in b)currentd[k]=b[k];a.selectedassets();b=angular.copy(a.data[f].extra.assets[c]);delete b.extra;
delete b.disabled;a.addupdateasset(b,f,c);console.log("submitting now")};a.checkgroupname=function(b,f,c){if(b.extra.groupname!=a.data[f].extra.assets[c].extra.groupname){groupid=null;customgroups=a.assetsOtherInfo.customgroups;for(i=0;i<customgroups.length;++i)if(b.extra.groupname==customgroups[i].groupname){groupid=customgroups[i].groupid;break}null==groupid?a.opengroupmodel(null,b.extra.groupname,b,f,c):(b.customgroupid=groupid,a.submitdefferredchanges(b,f,c))}else a.submitdefferredchanges(b,f,
c)};a.submitchanges=function(b,f){d=a.data[b].extra.assets[f].extra.copy;entereddetails={categoryname:d.extra.categoryname,subcategoryname:d.extra.subcategoryname,riskname:a.assetsOtherInfo.riskcategories[0].riskname};if(d.extra.categoryname!=a.data[f].extra.categoryname||d.extra.subcategoryname!=a.data[f].extra.subcategoryname){categoryid=null;categories=a.assetsOtherInfo.categories;for(i=0;i<categories.length;++i)if(entereddetails.categoryname==categories[i].categoryname){categoryid=categories[i].categoryid;
break}if(null==categoryid)a.opencategorymodel(null,entereddetails,d,b,f);else{subcategoryid=null;subcategories=a.assetsOtherInfo.subcategories;for(i=0;i<subcategories.length;++i)if(categoryid==subcategories[i].categoryid&&entereddetails.subcategoryname==subcategories[i].subcategoryname){subcategoryid=subcategories[i].subcategoryid;break}null==subcategoryid?a.opencategorymodel(null,entereddetails,d,b,f):(d.subcategoryid=subcategoryid,a.checkgroupname(d,b,f))}}else a.checkgroupname(d,b,f)};a.cancelchanges=
function(b,f){!0==a.data[b].extra.assets[f].extra.newrow?a.removerow(b,f):(delete a.data[b].extra.assets[f].extra.copy,a.data[b].extra.assets[f].extra.editMode=!1,a.selectedchildassets(b));console.log("cancelling now")};a.opencategorymodel=function(b,f,c,e,g){modalInstance=h.open({templateUrl:"ui/partials/categorymodel.html",controller:categoryModelController,size:b,resolve:{categorydetails:function(){return categoryInfo={entereddetails:f,assetsOtherInfo:a.assetsOtherInfo}}}});modalInstance.result.then(function(b){c.subcategoryid=
b.subcategoryid;c.extra.subcategoryname=b.subcategoryname;c.extra.categoryname=b.categoryname;a.checkgroupname(c,e,g)},function(){})};a.opengroupmodel=function(b,f,c,e,g){modalInstance=h.open({templateUrl:"ui/partials/groupmodel.html",controller:groupModelController,size:b,resolve:{groupdetails:function(){return groupInfo={groupname:f,assetsOtherInfo:a.assetsOtherInfo}}}});modalInstance.result.then(function(b){c.customgroupid=b.groupid;c.extra.groupname=b.groupname;a.submitdefferredchanges(c,e,g)},
function(){})};m?a.selectallgroupings(m):a.selectedassets()}}]);
app.controller("assetsController",["$scope","$rootScope","$http","$filter","$modal","Session",function(a,e,c,g,h,l){l.assetsotherinfodefferred.promise.then(function(a){return l.assetsinfodefferred.promise}).then(function(c){a.updateAssetsData(!0)});a.$on("assetsupdated",function(c,b){"assetsController"!=b&&"assetsControllerFirstLoad"!=b&&a.updateAssetsData(!1)});a.updateAssetsData=function(m){a.assetsInfo=l.assetsinfo;a.assetsOtherInfo=l.assetsotherinfo;console.log(a.assetsOtherInfo);a.data=a.assetsInfo.assets;
a.chartdata=[];a.assetchartincludeall=!0;for(index=0;index<a.data.length;++index)if(null==a.data[index].extra){a.data[index].extra={};categoryid=0;groupname=riskname=subcategoryname=categoryname="";subcategories=a.assetsOtherInfo.subcategories;categoryid=0;riskid=-1;for(i=0;i<subcategories.length;++i)if(subcategories[i].subcategoryid==a.data[index].subcategoryid){subcategoryname=subcategories[i].subcategoryname;categoryid=subcategories[i].categoryid;riskid=subcategories[i].riskid;break}categories=
a.assetsOtherInfo.categories;for(i=0;i<categories.length;++i)if(categories[i].categoryid==categoryid){categoryname=categories[i].categoryname;break}riskcategories=a.assetsOtherInfo.riskcategories;for(i=0;i<riskcategories.length;++i)if(riskcategories[i].riskid==riskid){riskname=riskcategories[i].riskname;break}customgroups=a.assetsOtherInfo.customgroups;for(i=0;i<customgroups.length;++i)if(customgroups[i].groupid==a.data[index].customgroupid){groupname=customgroups[i].groupname;break}a.data[index].extra.categoryid=
categoryid;a.data[index].extra.categoryname=categoryname;a.data[index].extra.subcategoryname=subcategoryname;a.data[index].extra.riskname=riskname;a.data[index].extra.groupname=groupname}a.selectedassets=function(){a.chartdata=g("filter")(a.data,{extra:{chartinclude:!0}})};a.selectallassets=function(){for(index=0;index<a.data.length;++index)a.data[index].extra.chartinclude=a.assetchartincludeall;a.selectedassets()};a.nameFunction=function(){return function(a){return a.assetname}};a.ppuFunction=function(){return function(a){null==
a.extra.dval&&(a.extra.dval=null!=a.ppu?a.ppu:0,a.extra.dval*=a.units,a.extra.dval=a.extra.dval.toFixed(2));return a.extra.dval}};a.getppu=a.ppuFunction();a.cppuFunction=function(){return function(a){null==a.extra.dcval&&(a.extra.dcval=null!=a.cppu?a.cppu:0,a.extra.dcval*=a.units,a.extra.dcval=a.extra.dcval.toFixed(2));return a.extra.dcval}};a.getcppu=a.cppuFunction();a.colorFunction=function(){return function(a,c){d=a.data;null==d&&(d=a);null==d.extra.color&&(d.extra.color=""==d.color||null==d.color?
"#"+Math.floor(16777215*Math.random()).toString(16):d.color);return d.extra.color}};a.getcolor=a.colorFunction();a.getdefaultasset=function(){return d={assetid:"0",subcategoryid:"",assetname:"",assetdescription:"",units:"",ppu:"",cppu:"",unitform:"",date:(new Date).toISOString().slice(0,10),color:"#"+Math.floor(16777215*Math.random()).toString(16),extra:{chartinclude:!0}}};a.getcagr=function(b){investeddate=new Date(b.date);currentdate=new Date;years=(currentdate-investeddate)/_MS_PER_DAY/365;days=
(currentdate-investeddate)/_MS_PER_DAY;if(30>days)return"NA";cppu=parseFloat(a.getcppu(b,!1));ppu=parseFloat(a.getppu(b,!1));cagr=100*(Math.pow(cppu/ppu,1/years)-1);return cagr.toFixed(2)};a.addrow=function(b){d=a.getdefaultasset();d.extra.dval=null;d.extra.dcval=null;d.extra.newrow=!0;-1==b?(a.data.push(d),b=a.data.length-1):a.data.splice(b,0,d);a.entereditmode(b)};a.removerow=function(b){assetid=a.data[b].assetid;a.data.splice(b,1);a.selectedassets();"0"!=assetid&&(data={assetid:assetid},a.removasset(data))};
a.removasset=function(a){c({method:"POST",url:"home/removeeasset",data:a,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(a){console.log("successfully removed data from server");e.$broadcast("assetsupdated","assetsController")})};a.addupdateasset=function(b,f){console.log(b);c({method:"POST",url:"home/addupdateasset",data:b,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(c){console.log("successfully sent data to server");
c&&"0"==b.assetid&&(a.data[f].assetid=c.assetid);e.$broadcast("assetsupdated","assetsController")})};a.entereditmode=function(b){a.data[b].extra.editMode=!0;d=angular.copy(a.data[b]);a.data[b].extra.copy=d};a.submitdefferredchanges=function(b,c){"string"==typeof b.date||b.date instanceof String||(b.date=b.date.toISOString().slice(0,10));b.extra.dval=null;b.extra.dcval=null;b.extra.color=null;b.extra.newrow=!1;b.extra.editMode=!1;a.data[c]=b;a.selectedassets();b=angular.copy(a.data[c]);delete b.extra;
delete b.disabled;a.addupdateasset(b,c);console.log("submitting now")};a.checkgroupname=function(b,c){if(b.extra.groupname!=a.data[c].extra.groupname){groupid=null;customgroups=a.assetsOtherInfo.customgroups;for(i=0;i<customgroups.length;++i)if(b.extra.groupname==customgroups[i].groupname){groupid=customgroups[i].groupid;break}null==groupid?a.opengroupmodel(null,b.extra.groupname,b,c):(b.customgroupid=groupid,a.submitdefferredchanges(b,c))}else a.submitdefferredchanges(b,c)};a.submitchanges=function(b){d=
a.data[b].extra.copy;entereddetails={categoryname:d.extra.categoryname,subcategoryname:d.extra.subcategoryname,riskname:a.assetsOtherInfo.riskcategories[0].riskname};if(d.extra.categoryname!=a.data[b].extra.categoryname||d.extra.subcategoryname!=a.data[b].extra.subcategoryname){categoryid=null;categories=a.assetsOtherInfo.categories;for(i=0;i<categories.length;++i)if(entereddetails.categoryname==categories[i].categoryname){categoryid=categories[i].categoryid;break}if(null==categoryid)a.opencategorymodel(null,
entereddetails,d,b);else{subcategoryid=null;subcategories=a.assetsOtherInfo.subcategories;for(i=0;i<subcategories.length;++i)if(categoryid==subcategories[i].categoryid&&entereddetails.subcategoryname==subcategories[i].subcategoryname){subcategoryid=subcategories[i].subcategoryid;break}null==subcategoryid?a.opencategorymodel(null,entereddetails,d,b):(d.subcategoryid=subcategoryid,a.checkgroupname(d,b))}}else a.checkgroupname(d,b)};a.cancelchanges=function(b){!0==a.data[b].extra.newrow?a.removerow(b):
(delete a.data[b].extra.copy,a.data[b].extra.editMode=!1,a.selectedassets());console.log("cancelling now")};a.datepickopen=function(b,c){b.preventDefault();b.stopPropagation();a.data[c].extra.opened=!0};a.opencategorymodel=function(b,c,e,g){modalInstance=h.open({templateUrl:"ui/partials/categorymodel.html",controller:categoryModelController,size:b,resolve:{categorydetails:function(){return categoryInfo={entereddetails:c,assetsOtherInfo:a.assetsOtherInfo}}}});modalInstance.result.then(function(b){e.subcategoryid=
b.subcategoryid;e.extra.subcategoryname=b.subcategoryname;e.extra.categoryname=b.categoryname;a.checkgroupname(e,g)},function(){})};a.opengroupmodel=function(b,c,e,g){modalInstance=h.open({templateUrl:"ui/partials/groupmodel.html",controller:groupModelController,size:b,resolve:{groupdetails:function(){return groupInfo={groupname:c,assetsOtherInfo:a.assetsOtherInfo}}}});modalInstance.result.then(function(b){e.customgroupid=b.groupid;e.extra.groupname=b.groupname;a.submitdefferredchanges(e,g)},function(){})};
a.selectallassets();m&&l.initialassstsupdate.resolve()}}]);
app.controller("homeController",["$scope","Session",function(a,e){a.getAssetsData=function(){e.getAssetsOtherInfo();e.getAssetsInfo();e.assetsotherinfodefferred.promise.then(function(a){return e.assetsinfodefferred.promise}).then(function(c){a.updateNetAssetsData()})};a.$on("assetsupdated",function(c,e){a.updateNetAssetsData()});a.updateNetAssetsData=function(){assetsdata=e.assetsinfo.assets;cppuFunction=function(a){dcval=null!=a.cppu?a.cppu:0;return dcval*=a.units};for(i=netassets=0;i<assetsdata.length;++i)netassets+=
cppuFunction(assetsdata[i]);a.netassets=netassets.toFixed(2)};a.tabselected=function(){for(i=0;i<nv.graphs.length;++i)nv.graphs[i].update()};a.getAssetsData()}]);app.controller("welcomeController",["$scope","$location",function(a,e){a.gotohome=function(){e.path("/home")}}]);
app.controller("loginController",["$scope","$http","$location","Session",function(a,e,c,g){a.formData={};a.formData.name="";a.formData.password="";a.processForm=function(){a.errorName="";a.errorPassword="";e({method:"POST",url:"login/loginUser",data:a.formData,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transformURIRequest}).success(function(e){e&&(g.updateSession(),e.success?c.path("/"):(a.errorName=e.errors.name,a.errorPassword=e.errors.password,a.message=e.errors.message))})}}]);
app.controller("userController",["$scope","$http","$rootScope","$timeout","$location","Session","$routeParams",function(a,e,c,g,h,l,m){function b(){c.timeCount--;0<c.timeCount?(c.alertInfo="You will be directed to Welcome / Login page in "+a.timeCount+" seconds",g(b,1E3)):(c.alertInfo="",h.path("/"))}a.updatePassword=!1;a.$watch("updatePassword",function(b){console.log("watch updatePassword");console.log(b);b||(console.log("clearing password"),a.formData.password="",a.formData.password2="",a.formData.currentpassword=
"")});a.formData={};a.showUser=!0;a.currentpassword=!0;l.data.configured?"register"===m.type?(a.formData.name="",a.formData.displayname="",a.register=!0,a.setPassword=!1,baseurlapi="user/register/new"):"update"===m.type&&(a.formData.name=l.currentuser.username,a.formData.displayname=l.currentuser.displayname,a.formData.admin=l.currentuser.admin,a.register=!1,a.setPassword=!1,a.currentPassword=l.data.userinfo.username==l.currentuser.username,baseurlapi="user/update"):(a.formData.name="admin",a.formData.displayname=
"Admin",a.register=!1,a.setPassword=!0,a.message="Provide password for admin",baseurlapi="user/firstrun/configure");a.setPassword=a.setPassword&&!a.register;a.showUpdateSettings=!a.register&&!a.setPassword;a.disableUser=!a.register;a.disableDisplayName=!(a.showUpdateSettings||a.register);a.processForm=function(){a.errorName="";a.errorCurrentPassword="";a.errorPassword="";a.errorPassword2="";a.alertMessage="";(a.updatePassword||a.register)&&a.formData.password!==a.formData.password2?a.errorPassword2=
"Passwords do not match. Please try again":(urlapi=baseurlapi,"update"===m.type&&(urlapi=a.updatePassword?urlapi+"/all":urlapi+"/displayname"),console.log(a.formData.password),e({method:"POST",url:urlapi,data:a.formData,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(a){str=[];for(p in a)str.push(encodeURIComponent(p)+"="+encodeURIComponent(a[p]));return str.join("&")}}).success(function(e){if(e)if(e.success){a.alertMessage=e.message;a.alertError=!1;if(a.register||
a.currentPassword)a.formData.admin="false";a.formData.password="";a.formData.password2="";a.formData.currentpassword="";l.updateSession();l.data.configured||(c.timeCount=5,c.alertInfo="You will be directed to Welcome / Login page in "+a.timeCount+" seconds",g(b,1E3))}else a.errorName=e.errors.name,a.errorPassword=e.errors.password,a.errorCurrentPassword=e.errors.currentpassword,a.alertMessage=e.errors.message,a.alertError=!0}))}}]);
