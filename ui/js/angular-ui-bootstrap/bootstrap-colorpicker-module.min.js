angular.module("colorpicker.module",[]).factory("Helper",function(){return{closestSlider:function(a){return(a.matches||a.webkitMatchesSelector||a.mozMatchesSelector||a.msMatchesSelector).bind(a)("I")?a.parentNode:a},getOffset:function(a,b){for(var d=0,c=0,h=0,g=0;a&&!isNaN(a.offsetLeft)&&!isNaN(a.offsetTop);)d+=a.offsetLeft,c+=a.offsetTop,b||"BODY"!==a.tagName?(h+=a.scrollLeft,g+=a.scrollTop):(h+=document.documentElement.scrollLeft||a.scrollLeft,g+=document.documentElement.scrollTop||a.scrollTop),
a=a.offsetParent;return{top:c,left:d,scrollX:h,scrollY:g}},stringParsers:[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(a){return[a[1],a[2],a[3],a[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(a){return[2.55*a[1],2.55*a[2],2.55*a[3],a[4]]}},{re:/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/,parse:function(a){return[parseInt(a[1],16),parseInt(a[2],
16),parseInt(a[3],16)]}},{re:/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/,parse:function(a){return[parseInt(a[1]+a[1],16),parseInt(a[2]+a[2],16),parseInt(a[3]+a[3],16)]}}]}}).factory("Color",["Helper",function(a){return{value:{h:1,s:1,b:1,a:1},rgb:function(){var b=this.toRGB();return"rgb("+b.r+","+b.g+","+b.b+")"},rgba:function(){var b=this.toRGB();return"rgba("+b.r+","+b.g+","+b.b+","+b.a+")"},hex:function(){return this.toHex()},RGBtoHSB:function(b,a,c,h){b/=255;a/=255;c/=255;var g,e;g=Math.max(b,
a,c);e=g-Math.min(b,a,c);b=((0===e?0:g==b?(a-c)/e:g==a?(c-b)/e+2:(b-a)/e+4)+360)%6*60/360;return{h:b||1,s:0===e?0:e/g,b:g,a:h||1}},setColor:function(b){b=b.toLowerCase();for(var d in a.stringParsers)if(a.stringParsers.hasOwnProperty(d)){var c=a.stringParsers[d],h=c.re.exec(b);if(c=h&&c.parse(h))return this.value=this.RGBtoHSB.apply(null,c),!1}},setHue:function(b){this.value.h=1-b},setSaturation:function(b){this.value.s=b},setLightness:function(b){this.value.b=1-b},setAlpha:function(b){this.value.a=
parseInt(100*(1-b),10)/100},toRGB:function(b,a,c,h){b||(b=this.value.h,a=this.value.s,c=this.value.b);var g,e,f;b=360*b%360/60;f=c*a;a=f*(1-Math.abs(b%2-1));c=g=e=c-f;b=~~b;c+=[f,a,0,0,a,f][b];g+=[a,f,f,a,0,0][b];e+=[0,0,a,f,f,a][b];return{r:Math.round(255*c),g:Math.round(255*g),b:Math.round(255*e),a:h||this.value.a}},toHex:function(a,d,c,h){a=this.toRGB(a,d,c,h);return"#"+(16777216|parseInt(a.r,10)<<16|parseInt(a.g,10)<<8|parseInt(a.b,10)).toString(16).substr(1)}}}]).factory("Slider",["Helper",function(a){var b=
{maxLeft:0,maxTop:0,callLeft:null,callTop:null,knob:{top:0,left:0}},d={};return{getSlider:function(){return b},getLeftPosition:function(a){return Math.max(0,Math.min(b.maxLeft,b.left+((a.pageX||d.left)-d.left)))},getTopPosition:function(a){return Math.max(0,Math.min(b.maxTop,b.top+((a.pageY||d.top)-d.top)))},setSlider:function(c,h){var g=a.closestSlider(c.target),e=a.getOffset(g,h);b.knob=g.children[0].style;b.left=c.pageX-e.left-window.pageXOffset+e.scrollX;b.top=c.pageY-e.top-window.pageYOffset+
e.scrollY;d={left:c.pageX,top:c.pageY}},setSaturation:function(a,d){b={maxLeft:100,maxTop:100,callLeft:"setSaturation",callTop:"setLightness"};this.setSlider(a,d)},setHue:function(a,d){b={maxLeft:0,maxTop:100,callLeft:!1,callTop:"setHue"};this.setSlider(a,d)},setAlpha:function(a,d){b={maxLeft:0,maxTop:100,callLeft:!1,callTop:"setAlpha"};this.setSlider(a,d)},setKnob:function(a,d){b.knob.top=a+"px";b.knob.left=d+"px"}}}]).directive("colorpicker",["$document","$compile","Color","Slider","Helper",function(a,
b,d,c,h){return{require:"?ngModel",restrict:"A",link:function(g,e,f,l){var q=f.colorpicker?f.colorpicker:"hex",n=angular.isDefined(f.colorpickerPosition)?f.colorpickerPosition:"bottom",m=angular.isDefined(f.colorpickerFixedPosition)?f.colorpickerFixedPosition:!1,D=angular.isDefined(f.colorpickerParent)?e.parent():angular.element(document.body),r=angular.isDefined(f.colorpickerWithInput)?f.colorpickerWithInput:!1,k=angular.element('<div class="colorpicker dropdown"><div class="dropdown-menu"><colorpicker-saturation><i></i></colorpicker-saturation><colorpicker-hue><i></i></colorpicker-hue><colorpicker-alpha><i></i></colorpicker-alpha><colorpicker-preview></colorpicker-preview>'+
(r?'<input type="text" name="colorpicker-input">':"")+'<button class="close close-colorpicker">&times;</button></div></div>'),s,E=k.find("colorpicker-hue"),w=k.find("colorpicker-saturation"),x=k.find("colorpicker-preview"),t=k.find("i");b(k)(g);if(r){var u=k.find("input");u.on("mousedown",function(){event.stopPropagation()}).on("keyup",function(a){var b=this.value;e.val(b);l&&g.$apply(l.$setViewValue(b));a.stopPropagation();a.preventDefault()});e.on("keyup",function(){u.val(e.val())})}var v=function(){a.on("mousemove",
p);a.on("mouseup",y)};"rgba"===q&&(k.addClass("alpha"),s=k.find("colorpicker-alpha"),s.on("click",function(a){c.setAlpha(a,m);p(a)}).on("mousedown",function(a){c.setAlpha(a,m);v()}));E.on("click",function(a){c.setHue(a,m);p(a)}).on("mousedown",function(a){c.setHue(a,m);v()});w.on("click",function(a){c.setSaturation(a,m);p(a)}).on("mousedown",function(a){c.setSaturation(a,m);v()});m&&k.addClass("colorpicker-fixed-position");k.addClass("colorpicker-position-"+n);D.append(k);l&&(l.$render=function(){e.val(l.$viewValue)},
g.$watch(f.ngModel,function(){z()}));e.on("$destroy",function(){k.remove()});var A=function(){try{x.css("backgroundColor",d[q]())}catch(a){x.css("backgroundColor",d.toHex())}w.css("backgroundColor",d.toHex(d.value.h,1,1,1));"rgba"===q&&(s.css.backgroundColor=d.toHex())},p=function(a){var b=c.getLeftPosition(a);a=c.getTopPosition(a);var f=c.getSlider();c.setKnob(a,b);f.callLeft&&d[f.callLeft].call(d,b/100);f.callTop&&d[f.callTop].call(d,a/100);A();b=d[q]();e.val(b);l&&g.$apply(l.$setViewValue(b));
r&&u.val(b);return!1},y=function(){a.off("mousemove",p);a.off("mouseup",y)},z=function(){d.setColor(e.val());t.eq(0).css({left:100*d.value.s+"px",top:100-100*d.value.b+"px"});t.eq(1).css("top",100*(1-d.value.h)+"px");t.eq(2).css("top",100*(1-d.value.a)+"px");A()},F=function(){var a,b,c=h.getOffset(e[0]);angular.isDefined(f.colorpickerParent)&&(c.left=0,c.top=0);"top"===n?(a=c.top-147,b=c.left):"right"===n?(a=c.top,b=c.left+126):"bottom"===n?(a=c.top+e[0].offsetHeight+2,b=c.left):"left"===n&&(a=c.top,
b=c.left-150);return{top:a+"px",left:b+"px"}},C=function(){B()};e.on("click",function(){z();k.addClass("colorpicker-visible").css(F());a.on("mousedown",C)});k.on("mousedown",function(a){a.stopPropagation();a.preventDefault()});var B=function(){k.hasClass("colorpicker-visible")&&(k.removeClass("colorpicker-visible"),a.off("mousedown",C))};k.find("button").on("click",function(){B()})}}}]);
